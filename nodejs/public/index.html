<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">
<head>
  <meta charset="utf-8">
  <title>JWT Generator</title>
  <link rel="icon" href="data:,">
  <style>
    html{
      height:100%;
      -webkit-text-size-adjust: 100%;
    }
    body {
      width: 100%;
      margin: 0;
      display: grid;
      grid-template-columns: [left] 196px [nav] 1fr [aside] minmax(212px, 256px) [right];
      grid-template-rows: [top] 56px [header] 1fr [footer] 96px [bottom];
      grid-gap: 4px;
      outline: 1px dashed #616161;
      min-height: 100vh;
      min-width: 0;
    }
    body > aside{
      overflow: hidden;
      min-width: 0;
      outline: 1px dashed #d50000;
      grid-column-start: aside;
      grid-column-end: right;
      grid-row-start: header;
      grid-row-end: footer;
      padding: 12px;
    }
    body > aside > section {
      margin: 0px 12px 0px 12px;
    }
    body > header {
      display: flex;
      flex-flow: row wrap;
      justify-content: center;
      align-content: center;
      align-items: flex-start;
      grid-row: row-line-1;
      min-width: 0;
      outline: 1px dashed #00c853;
      grid-column-start: left;
      grid-column-end: right;
      grid-row-start: top;
      grid-row-end: header; 
    }
    body> header a {
      text-decoration: none;
    }
    body > header > nav {
      min-width: 100%;
      display: flex;
      justify-content: center;
      align-content: center;
      align-items: center;
    }
    body > header > nav > div:nth-of-type(1) {
      flex: 1 1 auto;
      justify-content: flex-start;
      margin-left: 18px;
      display: flex;
      flex-direction: column;
    }
    body > header > nav > div:nth-of-type(1) a {
      display: flex;
      align-items: center;  
    }
    body > header > nav > div:nth-of-type(2) {
      flex: 0 1 auto;
      justify-content: flex-end;
      margin-right: 18px;
    }
    body > main {
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      outline 1px dashed #212121;
      overflow: hidden;  /* needed for scroll suppression */
      min-width: 0;      /* needed for scroll suppression */
      margin:18px;
      grid-column-start: nav;
      grid-column-end: aside;
      grid-row-start: header;
      grid-row-end: footer; 
    }
    body > nav {
      overflow: hidden;  /* needed for scroll suppression */
      min-width: 0;      /* needed for scroll suppression */
      text-align: center;
      outline: 1px dashed #2962ff;
      grid-column-start: left;
      grid-column-end: nav;
      grid-row-start: header;
      grid-row-end: footer; 
    }
    body > nav ul {
      list-style: none;
    }
    body > footer {
      grid-column-start: left;
      grid-column-end: right;
      grid-row-start: footer;
      grid-row-end: bottom;
      overflow: hidden;  /* needed for scroll suppression */
      min-width: 0;      /* needed for scroll suppression */
      outline: 1px dashed #ffd600;
      display: flex;
      justify-content: center;
    }
    body > footer > p {
      text-align: center;
      margin: 1em;
      color: #9e9e9e;
    }
    fieldset {
      max-width: 256px;
    }
    #buttons {
      float: right;
      margin-top: 24px;
    }
    #getTokenButton {
      margin-left:16px;
    }
    @media screen and (max-width: 767px) {
      body {
        grid-template-columns: [left] 0px [nav] 1fr [aside] 0px [right];
      }
    }    
  </style>
</head>
<body>
  <header>
    <nav>
      <div>
        <div>JWT Generator</div>
        <div><small>by Ronnie Royston</small></div>
      </div>
      <div id="account-div">
        <span id="account"></span>
      </div>
    </nav>  
  </header>
  <nav>
  </nav>
  <aside>
  </aside>
  <main>
  	<h1>
  		JSON Web Token (JWT) Client - The Web Browser
  	</h1>
  	<p>
  		Click the GET TOKEN button below to have the Node.js server generate a JSON Web Token, JWT. The JWT will be returned as an HTTP cookie. This implementation illustrates using JWT's as access tokens. Note that the use case for JWTs is not limited to access tokens, and, it is possible to implement JWTs as access tokens that bahave different from this implementation. This implementation is a sensible use case using sensible schemes.
  	</p>
    <p>
      Node's <a href="https://nodejs.org/api/crypto.html">crypt module</a> was used in this implementation, namely, the <code>createCipheriv, createDecipheriv, createSign, createVerify, createPrivateKey, createPublicKey, createSecretKey, randomFill, generateKey, generateKeyPairSync,</code> and <code>randomUUID</code> methods. For more information on the JWT algorithm see the RFC's <a href="https://datatracker.ietf.org/doc/html/rfc7516">JWE</a> and <a href="https://datatracker.ietf.org/doc/html/rfc7515">JWS</a>.
    </p>
    <h2>Different Behaviors</h2>
    <p>
      In this implementation of JSON Web Encryption (JWE) the token payload is not readable by the browser. Only the server can decrypt the JWE. This is why the <code>Sign In</code> button top right does not toggle to show the subscriber email address. A 256 bit Galois/Counter Mode AES Content Encryption Key (CEK) is used in direct encryption scheme meaning the same secret key is used to both encrypt and decrypt.
    </p>
    <p>
      JSON Web Signature (JWS) token payload is readable by the browser and the <code>Sign In</code> button top right toggles to show the subscriber email address. Asymmetric 2048 bit RSA keys are used in this scheme. The private key encrypts and the public key decrypts. Notice that the JWS is readable by anyone however only the server can validate the token signature. Manipulation of any part of the JWS results in the JWT being invalidated by the server.
    </p>
    <h2>How Does This Work?</h2>
    <h3>In The Browser</h3>
    <p>
      <b>Open Developer Tools in your web browser by pressing <code>Control + Shift + i</code>. Click <code>Application</code> then click <code>Cookies</code>. Notice when you click <code>Get Token</code> and <code>Logout</code> how the <code>token</code> cookie appears and disappears. The value of this cookie is the JSON Web Token (JWT).</b>
    </p>
    <h3>On The Node Server</h3>
    <p>
      <b>Open the <code>server.mjs</code> and <code>jwt.mjs</code> modules and inspect the easy to read code.</b>
    </p>
    <fieldset>
        <legend>JSON Web Token:</legend>
        <div>
          <input type="radio" id="jws" name="token-type" value="jws">
          <label for="jws">Signed (JWS)</label>
        </div>
        <div>
          <input type="radio" id="jwe" name="token-type" value="jwe" checked>
          <label for="jwe">Encrypted (JWE)</label>
        </div>
        <div id="buttons">
          <button id="logout">LOGOUT</button>
          <button id="getTokenButton">GET TOKEN</button>
        </div>
    </fieldset>
  </main>
   <footer>
    <p>
      Permission is hereby granted, free of charge. THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
    </p>
  </footer>
  <script>
    var cbn = (function() {
      const cookies = getCookies();
      const localhost = new URL("http://127.0.0.1:8080/auth");
      let pub = {};
      readAuth();
      window.addEventListener("focus", readAuth);

      document.querySelector("#getTokenButton").addEventListener("click", async function(e){
        try {
          let tokenType = document.querySelector("input[name=token-type]:checked").value;
          let url = new URL(`${localhost.origin}${localhost.pathname}?${tokenType}`);
          let response = await fetch(url.href);
          readAuth();
        } catch (error) {
          console.error(error);
        }
      
      })

      document.querySelector("#logout").addEventListener("click", async function(e){
        try {
          let response = await fetch("http://127.0.0.1:8080/logout");
          readAuth();
        } catch (error) {
          console.error(error);
        }
      })


      async function afterAuth() {
        if (pub.user) {
          document.querySelector("#account").textContent = pub.user.email;
        } else {
          document.querySelector("#account").textContent = "Sign In";
        }
      }

      function getCookies() {
        let cookie = document.cookie;
        if (cookie) {
          cookie = cookie.split("; ");
          let obj = {};
          cookie.forEach((item, index) => {
            let i = item.split("=");
            obj[i[0]] = i[1];
          });
          return obj;
        }
        return cookie;
      }

      async function readAuth() {
        try {
          pub.user = parseJws(getCookies().token)
        } finally {
          afterAuth();
        }
      }

      function parseJws (token) {
        try {
          var base64Url = token.split('.')[1];
          var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
          var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
              return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
          }).join(''));
          return JSON.parse(jsonPayload);
        } catch {
          return null;
        }
      }

      return pub; // Expose API
    }());

  </script>
  </body>
</html>